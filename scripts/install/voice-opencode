#!/bin/bash

set -euo pipefail

echo "ðŸš€ Iniciando configuraciÃ³n de OpenCode Voice para Arch Linux..."

# 1. Instalar dependencias del sistema
echo "ðŸ“¦ Instalando dependencias (sox y portaudio)..."
sudo pacman -S --needed sox portaudio alsa-utils

# Instalar dependencias de compilaciÃ³n y drivers CUDA
sudo pacman -S --needed cuda base-devel cmake

# Clonar y compilar whisper.cpp solo si no existe whisper-cli
if [ ! -f /usr/bin/whisper-cli ]; then
  cd /tmp
  git clone https://github.com/ggerganov/whisper.cpp.git
  cd whisper.cpp
  cmake -B build -DGGML_CUDA=OFF -DGGML_AVX2=ON -DGGML_FMA=ON -DGGML_F16C=ON
  cmake --build build --config Release -j"$(nproc)"

  echo "Whisper compilado con exito âœ…"
  sudo cp build/bin/whisper-cli /usr/bin/whisper-cli
else
  echo "âœ… whisper-cli ya existe en /usr/bin/whisper-cli, saltando compilaciÃ³n"
fi
# 3. Crear directorio para modelos
MODEL_DIR="$HOME/.local/share/whisper-models"
mkdir -p "$MODEL_DIR"

MODEL_URL="https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin"
if [ ! -f "$MODEL_DIR/ggml-base.bin" ]; then
  echo "ðŸ“¥ Descargando modelo Whisper (base)..."
  curl -L "$MODEL_URL" -o "$MODEL_DIR/ggml-base.bin"
else
  echo "âœ… El modelo ya existe en $MODEL_DIR"
fi

# 5. Permisos de audio
echo "ðŸ‘¤ Asegurando permisos de audio para el usuario $USER..."
sudo usermod -aG audio "$USER"

echo "âœ¨ Â¡ConfiguraciÃ³n completada! Reinicia tu sesiÃ³n para aplicar los grupos de audio."
